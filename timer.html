<script>
  const CONFIG_PATH = 'config.json';
  const STORAGE_KEY = 'escapeRoomEndTime_v1';
  let config = { timerMinutes: 60, redirectTimeUp: '', showResetButton: false };
  let endTime = null;
  let intervalId = null;

  async function loadConfig() {
    try {
      const res = await fetch(CONFIG_PATH + '?t=' + Date.now());
      const j = await res.json();
      config = Object.assign(config, j || {});
    } catch (e) {
      console.warn('Could not load config.json, using defaults', e);
    }
  }

  function formatMMSS(totalSec) {
    const m = Math.floor(totalSec / 60);
    const s = totalSec % 60;
    return String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');
  }

  function setEndFromNow() {
    const mins = Number(config.timerMinutes) || 60; // default 60 min
    endTime = Date.now() + mins * 60 * 1000;
    localStorage.setItem(STORAGE_KEY, String(endTime));
  }

  function initTimer() {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (!saved) {
      setEndFromNow();
    } else {
      endTime = Number(saved);
    }

    if (config.showResetButton) {
      document.getElementById('resetBtn').style.display = 'inline-block';
      document.getElementById('resetBtn').onclick = function () {
        setEndFromNow();
        document.getElementById('status').innerText = 'Timer reset';
      };
    }

    tick();
    intervalId = setInterval(tick, 1000);
  }

  // ✅ Safe redirect function (works inside Genially)
  function redirectTo(url) {
    try {
      if (window.top !== window.self) {
        window.top.location.href = url;
      } else {
        window.location.href = url;
      }
    } catch (err) {
      console.log("Redirect blocked by sandbox. Showing manual link...");
      document.body.innerHTML = `
        <div style="display:flex;align-items:center;justify-content:center;height:100vh;text-align:center;">
          <div>
            <h2 style="color:#d33;">⏰ Time’s Up!</h2>
            <p style="margin:10px 0;">Click below to continue</p>
            <a href="${url}" target="_blank" style="font-size:18px;background:#008000;color:#fff;padding:10px 18px;border-radius:8px;text-decoration:none;">Go to Next Page</a>
          </div>
        </div>`;
    }
  }

  function tick() {
    const now = Date.now();
    const remaining = Math.floor((endTime - now) / 1000);

    if (remaining <= 0) {
      clearInterval(intervalId);
      localStorage.removeItem(STORAGE_KEY);
      document.getElementById('minutes').innerText = '00:00';
      document.getElementById('status').innerText = "TIME'S UP!";

      const audio = document.getElementById('timeUpSound');
      audio.volume = 0.9;
      audio.play().catch(() => console.log('Autoplay blocked'));

      setTimeout(() => {
        if (config.redirectTimeUp) redirectTo(config.redirectTimeUp);
      }, 2000);
      return;
    }

    document.getElementById('minutes').innerText = formatMMSS(remaining);
  }

  (async function () {
    await loadConfig();
    initTimer();
  })();
</script>
