<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Escape Room Timer</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, Helvetica, sans-serif;
      background: transparent;
    }
    .wrap {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
    }
    .box {
      background: #fff;
      border-radius: 12px;
      padding: 14px 18px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
      text-align: center;
    }
    .label {
      font-size: 0.85rem;
      color: #444;
      margin-bottom: 6px;
      font-weight: 600;
    }
    .time {
      font-size: 1.6rem;
      font-weight: 700;
      color: #222;
      letter-spacing: 1px;
    }
    .small {
      font-size: 0.78rem;
      color: #666;
      margin-top: 8px;
    }
    button.reset {
      margin-top: 8px;
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid #ddd;
      background: #f4f4f4;
      cursor: pointer;
      display: none;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="box">
      <div class="label">Time Remaining</div>
      <div class="time" id="minutes">--:--</div>
      <div class="small" id="status"></div>
      <button id="resetBtn" class="reset">Reset</button>
    </div>
  </div>

  <script>
    const CONFIG_PATH = 'config.json';
    const STORAGE_KEY = 'escapeRoomEndTime_v1';
    let config = { timerMinutes: 15, redirectTimeUp: '', showResetButton: false };
    let endTime = null;
    let intervalId = null;

    function formatMMSS(totalSec) {
      const m = Math.floor(totalSec / 60);
      const s = totalSec % 60;
      return String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');
    }

    function getQueryParam(name) {
      try {
        return new URL(window.location.href).searchParams.get(name);
      } catch (e) {
        return null;
      }
    }

    async function loadConfig() {
      try {
        const res = await fetch(CONFIG_PATH + '?t=' + Date.now());
        const j = await res.json();
        config = Object.assign(config, j || {});
      } catch (e) {
        console.warn('Could not load config.json, using defaults', e);
      }
    }

    function setEndFromNow() {
      const mins = Number(config.timerMinutes) || 15;
      endTime = Date.now() + mins * 60 * 1000;
      localStorage.setItem(STORAGE_KEY, String(endTime));
    }

    function initTimer() {
      const reset = getQueryParam('reset');
      const saved = localStorage.getItem(STORAGE_KEY);
      if (reset === '1' || !saved) {
        setEndFromNow();
      } else {
        endTime = Number(saved);
      }

      if (config.showResetButton) {
        document.getElementById('resetBtn').style.display = 'inline-block';
      }

      document.getElementById('resetBtn').onclick = function() {
        setEndFromNow();
        document.getElementById('status').innerText = 'Timer reset';
      };

      tick();
      intervalId = setInterval(tick, 1000);
    }

    function tick() {
      const now = Date.now();
      let remaining = Math.floor((endTime - now) / 1000);
      if (remaining <= 0) {
        clearInterval(intervalId);
        localStorage.removeItem(STORAGE_KEY);
        document.getElementById('minutes').innerText = '00:00';
        document.getElementById('status').innerText = "TIME'S UP!";
        // âœ… Fullscreen redirect fix
        if (config.redirectTimeUp) {
          try {
            // Try to redirect entire Genially window (top frame)
            window.top.location.href = config.redirectTimeUp;
          } catch (e) {
            // Fallback to iframe redirect if blocked
            window.location.href = config.redirectTimeUp;
          }
        }
        return;
      }
      document.getElementById('minutes').innerText = formatMMSS(remaining);
    }

    (async function() {
      await loadConfig();
      initTimer();
    })();
  </script>
</body>
</html>
