<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Safe Lock</title>
  <style>
    body{margin:0;height:100vh;display:flex;align-items:center;justify-content:center;background:#fff;font-family:Arial,Helvetica,sans-serif}
    .safe-container{width:320px;text-align:center;padding:22px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.08);background:#fff}
    h2{margin:0 0 12px;color:#222}
    .display{width:100%;height:46px;border:1px solid #222;border-radius:8px;margin-bottom:14px;font-size:1.4rem;text-align:center;letter-spacing:8px;background:#fff}
    .keypad-area{background:#2ecc71;padding:16px;border-radius:10px}
    .keypad{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;justify-items:center}
    .key{width:62px;height:62px;border-radius:50%;background:#000;color:#fff;border:none;font-weight:700;font-size:1.15rem;cursor:pointer}
    .key:active{transform:scale(.97)}
    .actions{display:flex;justify-content:space-between;margin-top:14px}
    .btn{background:#444;color:#fff;border:none;padding:8px 14px;border-radius:8px;cursor:pointer;font-weight:600}
    #msg{margin-top:10px;height:18px;color:#d33;font-weight:600}
    .disabled{opacity:.45;pointer-events:none}
  </style>
</head>
<body>
  <div class="safe-container">
    <h2>Enter 4-Digit Code</h2>
    <input id="display" class="display" type="text" readonly maxlength="4" />
    <div class="keypad-area">
      <div id="keypad" class="keypad"></div>
    </div>
    <div class="actions">
      <button id="clear" class="btn">Clear</button>
      <button id="submit" class="btn disabled">Enter</button>
    </div>
    <div id="msg"></div>
  </div>

  <script>
    const CONFIG_PATH = 'config.json';
    let cfg = null;
    const display = document.getElementById('display');
    const keypad = document.getElementById('keypad');
    const msg = document.getElementById('msg');
    const submitBtn = document.getElementById('submit');
    const clearBtn = document.getElementById('clear');

    // keypad layout
    const keys = ['1','2','3','4','5','6','7','8','9','0'];
    keys.forEach(k => {
      const b = document.createElement('button');
      b.className = 'key';
      b.textContent = k;
      b.addEventListener('click', () => {
        if (display.value.length < 4) {
          display.value += k;
          msg.textContent = '';
        }
      });
      keypad.appendChild(b);
    });

    clearBtn.addEventListener('click', () => { display.value = ''; msg.textContent = ''; });

    // load config and normalize safeCode to string
    async function loadConfig(){
      try {
        const r = await fetch(CONFIG_PATH + '?t=' + Date.now());
        cfg = await r.json();
        // guarantee cfg.safeCode is a string
        cfg.safeCode = (cfg.safeCode === undefined || cfg.safeCode === null) ? '' : String(cfg.safeCode);
        console.log('Config loaded:', cfg);
        // enable submit now
        submitBtn.classList.remove('disabled');
      } catch (err) {
        console.error('Failed to load config.json', err);
        msg.textContent = 'Config load error';
      }
    }

    async function checkCode(){
      if (!cfg) {
        msg.textContent = 'Not ready yet';
        return;
      }
      const val = (display.value || '').trim();
      console.log('Entered:', val, 'Expected:', cfg.safeCode);
      if (val.length !== 4) {
        msg.style.color = '#d33';
        msg.textContent = 'Enter 4 digits';
        return;
      }

      if (val === String(cfg.safeCode)) {
        msg.style.color = '#1b8a3e';
        msg.textContent = '✅ Correct — redirecting...';
        // short delay for UX
        setTimeout(() => {
          if (cfg.redirectSafeSuccess) {
            try { top.location.href = cfg.redirectSafeSuccess; return; } catch(e){}
            window.location.href = cfg.redirectSafeSuccess;
          } else {
            console.warn('redirectSafeSuccess not set in config.json');
          }
        }, 500);
      } else {
        msg.style.color = '#d33';
        msg.textContent = '❌ Wrong code';
        setTimeout(() => {
          if (cfg.redirectSafeFail) {
            try { top.location.href = cfg.redirectSafeFail; return; } catch(e){}
            window.location.href = cfg.redirectSafeFail;
          } else {
            display.value = '';
            msg.textContent = '';
          }
        }, 500);
      }
    }

    // allow Enter key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') checkCode();
    });

    submitBtn.addEventListener('click', checkCode);

    loadConfig();
  </script>
</body>
</html>
